@model Web.Areas.StockAdministration.Models.Product.ProductOverviewModel
@using Microsoft.Web.Mvc;
@using Web.Areas.OutpostManagement.HtmlHelpers;
<link rel="stylesheet" href="../../Styles/tables.css" type="text/css" media="screen" />
@section page_title{
Stock Item: Overview
}
@section breadcrumbs{
    @*@Url.HomeLink("Outpost Administration") > Regions*@
}
@section master_actions{
    @{
        Html.RenderPartial("~/Views/Shared/_OutpostManagementActions.cshtml");
    }
    @{ Html.RenderPartial("~/Views/Shared/_StockAdministrationActions.cshtml");}
}
@section master_content{
    @{Html.RenderPartial("~/Views/Shared/_StockAdministrationHeader.cshtml");}
    <div class="page_header_buttons">
        @(Html.ActionLink<Web.Areas.StockAdministration.Controllers.ProductController>(it => it.Create(), "Add new product", Web.Areas.StockAdministration.StockAdministrationAreaRegistration.DEFAULT_ROUTE))
    </div>
    <br /><div class="pager">
   @Html.PageLinks(Model.PagingInfo, x => Url.Action("Overview", new {productGroupId = Model.ProductGroups.Where(it=>it.Selected==true),page = x}))
</div>
    <table class="searchable">
        <thead>
            <tr>
                <th>
                    <label>
                        Product Group:</label>
                    <select name="@(Html.NameFor(m => m.ProductGroups))">
                        <option value="@Guid.Empty">- Select a product group -</option>
                        @{
                            foreach (var item in Model.ProductGroups)
                            {
                            <option value="@item.Value" @(item.Selected ? @"selected='selected'" : @"") >@item.Text</option>
                            }
                        }
                    </select>
                </th>
                <th>
                    <input type="text" id="productSearch" name="productSearch" maxlength="50" placeholder="Products search"
                        style="width: 200px; height: 30px; margin-left: 0px; top: 100px" />
                </th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    @{
        Html.RenderPartial("OverviewTable", Model.Products);
    }

    
}
@section scripts{
    <script type="text/javascript">
        var timeout;
        $(function () {
            $(".delete-user-form").submit(function () {
                return confirm('Are you sure that you want to delete this stock item?')
            });
            $("select[name='@Html.NameFor(m => m.ProductGroups)']").change(onProductGroupChanged);

            document.getElementById("productSearch").onchange(searchProductAfter3Seconds);
        });
        function searchProductAfter3Seconds() {
            timeout = setTimeout("searchProductByName()", 3000);

        }

        function searchProductByName() {

            var productName = document.getElementById("productSearch").value;
            var drop = $("#products-overview")

            var urlOverview = '@Url.Action("SearchForProductWithName")?productName=' + productName;
            $.get(urlOverview, function (data) {

                drop.html('')

                $('#products-overview').html(data);
                clearTimeout(timeout);
            });
        }
        function onProductGroupChanged() {

            var e = $(this)[0];
            var selectedProductGroudId = e.options[e.selectedIndex].value;

            var drop = $("#products-overview")

            var urlOverview = '@Url.Action("OverviewTable")?productGroupId=' + selectedProductGroudId;
            $.get(urlOverview, function (data) {

                drop.html('')

                $('#products-overview').html(data);
            });
            $("select[name='@Html.NameFor(m => m.ProductGroups)'] option[value='@Guid.Empty.ToString()']").remove();
        }

        //search for products by Name

        //jQuery.expr[":"].containsNoCase = function (el, i, m) {
           // var search = m[3];
           // if (!search) return false;
           // return eval("/" + search + "/i").test($(el).text());
        //};

        //jQuery(document).ready(function () {

            // cancel the search if the user presses the ESC key
            //jQuery('#productSearch').keyup(function (event) {
                //if (event.keyCode == 27) {
                  //  resetSearch();
               // }
            //});

            // execute the search
            //jQuery('#productSearch').keyup(function () {
                // only search when there are 3 or more characters in the textbox
                //if (jQuery('#productSearch').val().length > 0) {
                    // hide all rows
                   // jQuery('#products-overview tr').hide();
                    // show the header row
                   // jQuery('#products-overview tr:first').show();
                    // show the matching rows (using the containsNoCase from Rick Strahl)
                 //   jQuery('#products-overview tr td:containsNoCase(\'' + jQuery('#productSearch').val() + '\')').parent().show();
               // }
               // else if (jQuery('#productSearch').val().length == 0) {
                    // if the user removed all of the text, reset the search
                  //  resetSearch();
               // }

                // if there were no matching rows, tell the user
               // if (jQuery('#products-overview tr:visible').length == 1) {
                    // remove the norecords row if it already exists
                   // jQuery('.norecords').remove();
                    // add the norecords row
                   // jQuery('#products-overview').append('<tr class="norecords"><td colspan="5" class="Normal">No records were found</td></tr>');
                //}
            //});
       // });

        //function resetSearch() {
            // clear the textbox
           // jQuery('#productSearch').val('');
            // show all table rows
            //jQuery('#stockitems tr').show();
            // remove any no records rows
            //jQuery('.norecords').remove();
            // make sure we re-focus on the textbox for usability
            //jQuery('#productSearch').focus();
        }
    </script>
}
