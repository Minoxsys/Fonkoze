@section page_title{
Analysis
}
@using Web.Areas.AnalysisManagement;
@{
    Html.RenderPartial("ReportMainContent");
    Html.RenderPartial("AnalysisUserInfoContainer");
}
<script type="text/javascript">

    Ext.onReady(function () {

        var analysisBtnId = window.res.header.navigation.analysisAndReports;
        var analysisBtn = Ext.getCmp(analysisBtnId);
        analysisBtn.toggle(true);
    });

</script>
<script type="text/javascript">
    Ext.onReady(function () {
        window.feature = {};

        window.feature.comboboxCountriesId = 'comboboxCountriesId';
        window.feature.comboboxRegionsId = 'combobxRegionsId';
        window.feature.comboboxDistrictsId = 'comboboxDistrictsId';

        window.feature.CountryStore = Ext.create('Ext.data.Store', {
            fields: ['Name', 'Id'],
            proxy: {
                type: 'ajax',
                url: '@Url.RouteUrl(AnalysisManagementAreaRegistration.DEFAULT_ROUTE, new { controller = "ReportRegionLevel", action = "GetCountries" })',
                reader: {
                    type: 'json',
                    root: 'countries',
                    disableCaching: true,
                    totalProperty: 'TotalItems'
                }
            }
        });

        window.feature.RegionStore = Ext.create('Ext.data.Store', {
            fields: ['Name', 'Id'],
            proxy: {
                type: 'ajax',
                url: '@Url.RouteUrl(AnalysisManagementAreaRegistration.DEFAULT_ROUTE, new { controller = "ReportRegionLevel", action = "GetRegions" })',
                reader: {
                    type: 'json',
                    root: 'regions',
                    disableCaching: true,
                    totalProperty: 'TotalItems'
                }
            },
            listeners: {
            datachanged: function(){
                 var regionIdAll = this.data.items[0].data.Id;
                 window.feature.comboBoxRegions.setValue(regionIdAll);
            }}
        });       

         window.feature.DistrictStore = Ext.create('Ext.data.Store', {
            fields: ['Name', 'Id'],
            proxy: {
                type: 'ajax',
                url: '@Url.RouteUrl(AnalysisManagementAreaRegistration.DEFAULT_ROUTE, new { controller = "ReportDistrictLevel", action = "GetDistricts" })',
                reader: {
                    type: 'json',
                    root: 'districts',
                    disableCaching: true,
                    totalProperty: 'TotalItems'
                }
            },
            listeners: {
            datachanged: function(){
                 var districtIdAll = this.data.items[0].data.Id;
                 window.feature.comboboxDistricts.setValue(districtIdAll);
            }}
        });       

        window.feature.comboBoxCountries = Ext.create('Ext.form.ComboBox', {
            store: window.feature.CountryStore,
            queryMode: 'local',
            id: window.feature.comboboxCountriesId,
            labelAlign: 'top',
            fieldLabel: 'Selected Country',
            labelClsExtra:'combo-label',
            displayField: 'Name',
            valueField: 'Id',
            emptyText: _t('Country List'),
            listeners: {
                select: function (combo, record, index) {
                    var selectedCountryId = record[0].data.Id;
                    window.feature.comboBoxRegions.setValue(null);
                    window.feature.comboboxDistricts.setValue(null);

                    window.feature.treegrid.getStore().proxy.extraParams.CountryId ='';
                    window.feature.treegrid.getStore().proxy.extraParams.RegionId = '';
                    window.feature.treegrid.getStore().proxy.extraParams.DistrictId = '';

                    window.feature.treegrid.setRootNode(null);
                    window.feature.RegionStore.load({
                                           params: { CountryId: selectedCountryId }
                                       });
                     window.feature.DistrictStore.load({
                                           params: { CountryId: selectedCountryId, RegionId: '' }
                                           });
                                          
                     window.feature.treegrid.getStore().proxy.extraParams.CountryId = selectedCountryId;
                     window.feature.treegrid.getStore().proxy.extraParams.RegionId = '';
                     window.feature.treegrid.getRootNode().expand();
                  }
            }
        });

        window.feature.comboBoxRegions = Ext.create('Ext.form.ComboBox', {
            store: window.feature.RegionStore,
            queryMode: 'local',
            id: window.feature.comboboxRegionsId,
            labelAlign: 'top',
            fieldLabel: 'Selected Region',
            labelClsExtra:'combo-label',
            displayField: 'Name',
            valueField: 'Id',
            margin: '0 0 0 20',
            emptyText: _t('Region List'),
            listeners: {
                select: function (combo, record, index) {
                 var selectedRegionId = record[0].data.Id;
                 var selectedCountryId = Ext.getCmp(window.feature.comboboxCountriesId).getValue();
                 window.feature.comboboxDistricts.setValue(null);
                 window.feature.treegrid.getStore().proxy.extraParams.DistrictId = '';

                 window.feature.DistrictStore.load({
                                           params: { CountryId: selectedCountryId, RegionId: selectedRegionId }
                                           });
                 window.feature.treegrid.setRootNode(null);
                 window.feature.treegrid.getStore().proxy.extraParams.RegionId = selectedRegionId;
                 window.feature.treegrid.getRootNode().expand();
                }
            }
        });

         window.feature.comboboxDistricts = Ext.create('Ext.form.ComboBox', {
            store: window.feature.DistrictStore,
            queryMode: 'local',
            id: window.feature.comboboxDistrictsId,
            labelAlign: 'top',
            fieldLabel: 'Selected District',
            labelClsExtra:'combo-label',
            displayField: 'Name',
            valueField: 'Id',
            margin: '0 0 0 20',
            emptyText: _t('District List'),
            listeners: {
                select: function (combo, record, index) {
                 var selectedDistrictId = record[0].data.Id;
                 window.feature.treegrid.setRootNode(null);
                 window.feature.treegrid.getStore().proxy.extraParams.DistrictId = selectedDistrictId;
                 window.feature.treegrid.getRootNode().expand();
                }
            }
        });
        Ext.define('ReportDistrictLevel', {
            extend: 'Ext.data.Model',
            fields: ['Name','ProductLevelSum','leaf']
        });

        window.feature.treeStore = Ext.create('Ext.data.TreeStore', {
            model: 'ReportDistrictLevel',
            autoLoad: false,
            root: {},
            proxy: {
                type: 'ajax',
                url: '@Url.RouteUrl(AnalysisManagementAreaRegistration.DEFAULT_ROUTE, new { controller = "ReportDistrictLevel", action = "GetReports" })',
                extraParams: { CountryId: '', RegionId: '', DistrictId: ''}
            }
        });

        window.feature.treegrid = Ext.create('Ext.tree.Panel', {
            useArrows: true,
            cls: 'white-border',
            rootVisible: false,
            flex: 3,
            height: 600,
            scroll: 'vertical',
            root: {},
            store: window.feature.treeStore,
            multiSelect: true,
            singleExpand: false,
            columns: [{
                xtype: 'treecolumn',
                text: 'Region / Product Group / Product',
                flex: 2,
                sortable: true,
                menuDisabled:true,
                dataIndex: 'Name'
            }, {
                xtype: 'templatecolumn',
                text: 'Product Level',
                flex: 1,
                sortable: true,
                menuDisabled:true,
                dataIndex: 'ProductLevelSum',
                align: 'center',
                tpl: Ext.create('Ext.XTemplate', '{ProductLevelSum:this.ProductLevelSum}', {
                    ProductLevelSum: function (value) {
                        return value;
                    }
                })
            }]
        });

         window.feature.CountryStore.load();

        var contentRes = window.res.content;

        var mainContent = Ext.getCmp(contentRes.maincontent.id);
        mainContent.add({
            xtype: 'container',
            margin:'45 50 20 20',
            padding:'20 0 0 20',
            autoScroll: true,
            id: 'TopContainer',
            layout: {
                align: 'stretch',
                type: 'vbox'
            },
            items: [{
                xtype: 'container',
                layout: {
                    align: 'stretch',
                    type: 'vbox'
                },
                height: 150,
                items: [
                {
                    xtype: 'container',
                    flex: 1,
                    layout: {
                        type: 'column'
                    },
                    items: [{
                        xtype: 'container',
                        height: 30,
                        width: 30,
                        html:'&nbsp;'
                    },{
                        xtype: 'label',
                        cls: 'x-title-label',
                        text: 'Product level information at district level',
                    }]
                    },{
						xtype: 'container',
                        flex: 1,
						layout: {
							type: 'column'
						},
						items: [
						{
							xtype: 'container',
							height: 30,
							width: 30,
							html:'&nbsp;'
						}, 
                            window.feature.comboBoxCountries, 
							window.feature.comboBoxRegions,
                            window.feature.comboboxDistricts							
                        ]
				    }]
			}, window.feature.treegrid]
        });

    });
</script>
