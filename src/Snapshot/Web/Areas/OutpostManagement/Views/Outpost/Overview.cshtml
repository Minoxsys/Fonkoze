@using Web.Areas.OutpostManagement.HtmlHelpers
@using Web.Areas.OutpostManagement.Models
@using Web.Areas.OutpostManagement.Models.Outpost

@model OutpostOverviewModel
           
@section page_title
{
OutpostManagement Outposts: Overview
}

@section title_bar
{
}

@section breadcrumbs
{
   @Url.HomeLink("Outpost Administration") > Outposts
   }

@section master_content
{

    @if (Model.Error != null)
    {
        <div class="error">
            @Model.Error
        </div>
        
    }

    <div class="page_header_buttons">
        @(Html.ActionLink<OutpostController>(it => it.Create(), "Add new Outpost", OutpostManagementAreaRegistration.DEFAULT_ROUTE))
    </div>
 
    <div>
    <table id="DistrictSearch">
        <thead>
            <tr>
                <th>
                    <label>
                        Country:</label>
                    <select name="@(Html.NameFor(m => m.Countries))">
                        <option value="@Guid.Empty">- Select a country - </option>
                        @{
                            foreach (var item in Model.Countries)
                            {
                            <option value="@item.Value" @(item.Selected ? @"selected='selected'" : @"") >@item.Text</option>
                            }
                        }
                    </select>
                </th>
                <th>
                    <label>
                        Region:</label>
                    @Html.DropDownList("Regions", Model.Regions, new { onChange = "onRegionChanged()" })
                </th>
                <th>
                    <label>
                        District:</label>
                    @Html.DropDownList("Districts", Model.Districts, new { onChange = "onDistrictChanged()" })
                </th>
         </thead>
        <tbody>
        </tbody>
    </table>
    </div>

    <div class="pager">
  @* @Html.PageLinks(Model.PagingInfo, x => Url.Action("Overview", new {page = x}))*@
</div>
<div>
    @{
        Html.RenderPartial("OverviewOutpost", Model.Outposts);
    }
    </div>
}

@section master_actions{
    @{
        Html.RenderPartial("~/Views/Shared/_OutpostManagementActions.cshtml");
    }
}


@section scripts{
    <script type="text/javascript">
        $(function () {
            $(".delete-user-form").submit(function () {
                return confirm('Are you sure that you want to delete this Outpost?')
            });

            $("select[name='@Html.NameFor(m=>m.Countries)']").change(onCountryChanged);
        });


        function onCountryChanged() {
            var e = $(this)[0];
            var selectedCountryId = e.options[e.selectedIndex].value;

            $.getJSON('@Url.Action("GetRegionsForCountry", "District")?countryId=' + selectedCountryId, function (data) {
                var drop = $("#Regions")
                drop.html('');

                var drop = $("#regions-overview")
                drop.html('');

                var ddlRegions = document.getElementById("Regions");
                var opt = document.createElement("option");
                opt.text = 'Please select a region';
                opt.value = '@Guid.Empty.ToString()';
                ddlRegions.options.add(opt);

                $.each(data, function () {
                    var opt = document.createElement("option");
                    opt.text = this['Text'];
                    opt.value = this['Value'];
                    ddlRegions.options.add(opt);
                });

            });

            $("select[name='@Html.NameFor(m => m.Countries)'] option[value='@Guid.Empty.ToString()']").remove();
        }

        function onRegionChanged() {
            var reg = document.getElementById("Regions");
            var selectedRegionId = reg.options[reg.selectedIndex].value;

            $.getJSON('@Url.Action("GetDistrictsForRegion", "Outpost")?regionId=' + selectedRegionId, function (data) {
                var drop = $("#Districts")
                drop.html('');

                var drop = $("#districts-overview")
                drop.html('');

                var ddlDistricts = document.getElementById("Districts");
                var opt = document.createElement("option");
                opt.text = 'Please select a district';
                opt.value = '@Guid.Empty.ToString()';
                ddlDistricts.options.add(opt);

                $.each(data, function () {
                    var opt = document.createElement("option");
                    opt.text = this['Text'];
                    opt.value = this['Value'];
                    ddlDistricts.options.add(opt);
                });

            });

            $("select[name='@Html.NameFor(m => m.Regions)'] option[value='@Guid.Empty.ToString()']").remove();
        }

        function onDistrictChanged() {

            var reg = document.getElementById("Districts");

            var selectedDistrictId = reg.options[reg.selectedIndex].value;

            $("#Districts option[value='@Guid.Empty.ToString()']").remove();
            var drop = $("#outpost-overview")
            drop.html('')

            var urlOverview = '@Url.Action("OverviewOutpost")?districtId=' + selectedDistrictId;
            $.get(urlOverview, function (data) {
                console.log(data);
                $('#outpost-overview').html(data);
            });

        }

    </script>
}


     