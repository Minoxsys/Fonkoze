@model Web.Areas.OutpostManagement.Models.District.DistrictOverviewModel
@using Microsoft.Web.Mvc
@{
    ViewBag.Title = "Overview";
}
@section page_title{
Districts: Overview
}
@{
    Html.RenderPartial("_SubNavigation");
    Html.RenderPartial("_OutpostAdministrationSideBar");
}
<script type="text/javascript">
    Ext.onReady(function () {

        var administrationBtnId = window.res.header.navigation.administration;
        var administrationBtn = Ext.getCmp(administrationBtnId);
        administrationBtn.toggle(true);

        var districtSideBarBtnId = window.res.content.maincontent.sidebar.district;
        var districtBtn = Ext.getCmp(districtSideBarBtnId);

        districtBtn.toggle(true);

    });
</script>
<script type="text/javascript">
    Ext.onReady(function () {
        window.feature = {};
        window.feature.comboboxCountriesForModalId = 'countriesComboboxForModalId';
        window.feature.comboboxRegionsForModalId = 'regionsComboboxForModalId';
        window.feature.districtNameId = 'districtName';
        window.feature.comboboxRegionsId = 'regionsCombobox';
        window.feature.comboboxCountriesId = 'countriesCombobox';
        window.feature.clientId = 'clientIdForEditModal';
        window.feature.DistrictId ='districtId';
        
        window.feature.regionsStore = Ext.create('Ext.data.Store', {
            fields: ['Name', 'Id'],
            proxy: {
                type: 'ajax',
                url: '@Url.RouteUrl(OutpostManagementAreaRegistration.DEFAULT_ROUTE, new { controller = "District", action = "GetRegions" })',
                reader: {
                    type: 'json',
                    root: 'regions',
                    disableCaching: true,
                    totalProperty: 'TotalItems'
                }

            }

        });

        window.feature.countriesStore = Ext.create('Ext.data.Store', {
            fields: ['Name', 'Id'],
            proxy: {
                type: 'ajax',
                url: '@Url.RouteUrl(OutpostManagementAreaRegistration.DEFAULT_ROUTE, new { controller = "District", action = "GetCountries" })',
                reader: {
                    type: 'json',
                    root: 'countries',
                    disableCaching: true,
                    totalProperty: 'TotalItems'
                }
            }
        });
        window.feature.regionsStoreforModal = Ext.create('Ext.data.Store', {
            fields: ['Name', 'Id'],
            proxy: {
                type: 'ajax',
                url: '@Url.RouteUrl(OutpostManagementAreaRegistration.DEFAULT_ROUTE, new { controller = "District", action = "GetRegions" })',
                reader: {
                    type: 'json',
                    root: 'regions',
                    disableCaching: true,
                    totalProperty: 'TotalItems'
                }

            }

        });
        window.feature.countriesStoreforModal = Ext.create('Ext.data.Store', {
            fields: ['Name', 'Id'],
            proxy: {
                type: 'ajax',
                url: '@Url.RouteUrl(OutpostManagementAreaRegistration.DEFAULT_ROUTE, new { controller = "District", action = "GetCountries" })',
                reader: {
                    type: 'json',
                    root: 'countries',
                    disableCaching: true,
                    totalProperty: 'TotalItems'
                }
            }
        });

        window.feature.modal = Ext.define('Ext.feature.district.Modal', {
            extend: 'Ext.window.Window',
            title: 'Add new District',
            height: 170,
            width: 390,
            modal: true,
            layout: {
                align: 'stretch',
                padding: 10,
                type: 'vbox'
            },
            initComponent: function () {
                var me = this;

                Ext.applyIf(me, {
                    items: [{ xtype: 'combobox',
                        fieldLabel: 'Country',
                        store: window.feature.countriesStoreforModal,
                        queryMode: 'local',
                        displayField: 'Name',
                        valueField: 'Id',
                        id: window.feature.comboboxCountriesForModalId,
                        emptyText: 'Select a country',
                        listeners:
                                   { select: function (combo, record, index) {
                                       var selectedCountryId = record[0].data.Id;
                                       window.feature.regionsStoreforModal.load({
                                           params: { countryId: selectedCountryId }
                                       });
                                   }
                                   }
                    },
                                 { xtype: 'combobox',
                                     fieldLabel: 'Region',
                                     store: window.feature.regionsStore,
                                     queryMode: 'local',
                                     displayField: 'Name',
                                     valueField: 'Id',
                                     id: window.feature.comboboxRegionsForModalId,
                                     emptyText: _t('Select a region'),
                                     store: window.feature.regionsStoreforModal
                                 },
                                            {
                                                xtype: 'textfield',
                                                name: 'Name',
                                                fieldLabel: 'District Name',
                                                allowBlank:false,
                                                id: window.feature.districtNameId,
                                                anchor: '100%'
                                            }]
                });
                me.listeners = {
                    afterrender: function () {
                        window.feature.countriesStoreforModal.load();

                        var selectedCountryValue = window.feature.comboBoxCountries.getValue();
                        var selectedRegionValue = window.feature.comboBoxRegions.getValue();
                        var comboboxRegionForModal = Ext.getCmp(window.feature.comboboxRegionsForModalId);
                        var comboboxCountriesForModal = Ext.getCmp(window.feature.comboboxCountriesForModalId);

                        if ((selectedCountryValue !== null) && (selectedRegionValue !== null)) {
                            comboboxCountriesForModal.value = selectedCountryValue;
                            window.feature.regionsStoreforModal.load({
                                params: { countryId: selectedCountryValue }
                            });
                            comboboxRegionForModal.value = selectedRegionValue;
                        }
                        else {
                            if (selectedCountryValue !== null) {
                                comboboxCountriesForModal.value = selectedCountryValue;
                                window.feature.regionsStoreforModal.load({
                                    params: { countryId: selectedCountryValue }
                                });
                            }
                        }

                    }

                };

                me.buttons = [{ text: 'Cancel', handler: function () { me.close(); me.destroy(); }
                }, {
                    text: 'Save', handler: function () {
                        var values = {
                            'districtInputModel.Name': me.down('#' + window.feature.districtNameId).getValue(),
                            'districtInputModel.Region.Id': Ext.getCmp(window.feature.comboboxRegionsForModalId).getValue()
                        };
                        var postToUrl = '@Url.RouteUrl(OutpostManagementAreaRegistration.DEFAULT_ROUTE, new { controller = "District", action = "Create" })';
                        var action = $.post(postToUrl, values);
                        action.success(function () {

                            var selectedCountryInModal = Ext.getCmp(window.feature.comboboxCountriesForModalId).getValue();
                            var selectedRegionInModal = Ext.getCmp(window.feature.comboboxRegionsForModalId).getValue();
                            me.close();
                            me.destroy();

                            window.feature.regionsStore.load({
                                params: { countryId: selectedCountryInModal }
                            });
                            var combobox = Ext.getCmp(window.feature.comboboxCountriesId);
                            combobox.setValue(selectedCountryInModal);
                            Ext.getCmp(window.feature.comboboxRegionsId).value = selectedRegionInModal;

                            window.feature.store.loadPage(1, {
                                params: { RegionId: selectedRegionInModal }
                            });
                        });
                    }
                }]
                me.callParent(arguments);
            }
        });


        window.feature.modalEdit = Ext.define('Ext.feature.district.ModalEdit', {
            extend: 'Ext.window.Window',
            title: 'Edit District',
            height: 170,
            width: 390,
            modal: true,
            layout: {
                align: 'stretch',
                padding: 10,
                type: 'vbox'
            },
            initComponent: function () {
                var me = this;

                Ext.applyIf(me, {
                    items: [{ xtype: 'combobox',
                        fieldLabel: 'Country',
                        store: window.feature.countriesStoreforModal,
                        queryMode: 'local',
                        displayField: 'Name',
                        valueField: 'Id',
                        id: window.feature.comboboxCountriesForModalId,
                        emptyText: _t('Select a country'),
                        listeners:
                                   { select: function (combo, record, index) {
                                       var selectedCountryId = record[0].data.Id;
                                       Ext.getCmp(window.feature.comboboxRegionsForModalId).setValue(null);
                                       window.feature.regionsStoreforModal.load({
                                           params: { countryId: selectedCountryId }
                                       });
                                   }
                                   }
                    }, { xtype: 'combobox',
                        fieldLabel: 'Region',
                        store: window.feature.regionsStore,
                        queryMode: 'local',
                        displayField: 'Name',
                        valueField: 'Id',
                        id: window.feature.comboboxRegionsForModalId,
                        emptyText: _t('Select a region'),
                        store: window.feature.regionsStoreforModal
                    }, { xtype: 'textfield',
                        name: 'Name',
                        fieldLabel: _t('District Name'),
                        id: window.feature.districtNameId,
                        allowBlank: false,
                        anchor: '100%'
                    }, { xtype: 'textfield',
                        hidden: true,
                        name: 'ClientId',
                        id: window.feature.clientId

                    },{ xtype: 'textfield',
                        hidden: true,
                        name: 'ClientId',
                        id: window.feature.DistrictId

                    }]
                });
                me.listeners = {
                    afterrender: function () {
                        window.feature.countriesStoreforModal.load();

                        var selectedCountryValue = window.feature.comboBoxCountries.getValue();
                        var selectedRegionValue = window.feature.comboBoxRegions.getValue();
                        var comboboxRegionForModal = Ext.getCmp(window.feature.comboboxRegionsForModalId);
                        var comboboxCountriesForModal = Ext.getCmp(window.feature.comboboxCountriesForModalId);

                        if ((selectedCountryValue !== null) && (selectedRegionValue !== null)) {
                            comboboxCountriesForModal.value = selectedCountryValue;
                            window.feature.regionsStoreforModal.load({
                                params: { countryId: selectedCountryValue }
                            });
                            comboboxRegionForModal.value = selectedRegionValue;
                        }
                        else {
                            if (selectedCountryValue !== null) {
                                comboboxCountriesForModal.value = selectedCountryValue;
                                window.feature.regionsStoreforModal.load({
                                    params: { countryId: selectedCountryValue }
                                });
                            }
                        }

                    }

                };

                me.buttons = [{ text: 'Cancel', handler: function () { me.close(); me.destroy(); }
                }, {
                    text: 'Save', handler: function () {
                        var values = {
                            'districtInputModel.Name': me.down('#' + window.feature.districtNameId).getValue(),
                            'districtInputModel.Region.Id': Ext.getCmp(window.feature.comboboxRegionsForModalId).getValue(),
                            'districtInputModel.Client.Id': Ext.getCmp(window.feature.clientId).getValue(),
                            'districtInputModel.Id': Ext.getCmp(window.feature.DistrictId).getValue()
                        };
                        var postToUrl = '@Url.RouteUrl(OutpostManagementAreaRegistration.DEFAULT_ROUTE, new { controller = "District", action = "Edit" })';
                        var action = $.post(postToUrl, values);
                        action.success(function () {

                            var selectedCountryInModal = Ext.getCmp(window.feature.comboboxCountriesForModalId).getValue();
                            var selectedRegionInModal = Ext.getCmp(window.feature.comboboxRegionsForModalId).getValue();
                            me.close();
                            me.destroy();

                            window.feature.regionsStore.load({
                                params: { countryId: selectedCountryInModal }
                            });
                            var combobox = Ext.getCmp(window.feature.comboboxCountriesId);
                            combobox.setValue(selectedCountryInModal);
                            Ext.getCmp(window.feature.comboboxRegionsId).value = selectedRegionInModal;

                            window.feature.store.loadPage(1, {
                                params: { RegionId: selectedRegionInModal }
                            });
                        });
                    }
                }]
                me.callParent(arguments);
            },
            
        });
    });
</script>

<script type="text/javascript">

    Ext.onReady(function () {
        window.feature.searchTextFieldId = 'searchTextField';
        var timeout;

        window.feature.comboBoxCountries = Ext.create('Ext.form.ComboBox', {
            store: window.feature.countriesStore,
            queryMode: 'local',
            id: window.feature.comboboxCountriesId,
            displayField: 'Name',
            valueField: 'Id',
            margin: '0 0 0 30',
            emptyText: _t('Selected country'),
            listeners: {
                select: function (combo, record, index) {
                    var selectedCountryId = record[0].data.Id;
                    window.feature.comboBoxRegions.setValue(null);
                    window.feature.regionsStore.load({
                        params: { countryId: selectedCountryId }
                    });

                }
            }
        });

        window.feature.comboBoxRegions = Ext.create('Ext.form.ComboBox', {
            store: window.feature.regionsStore,
            queryMode: 'local',
            displayField: 'Name',
            valueField: 'Id',
            id: window.feature.comboboxRegionsId,
            margin: '0 0 0 35',
            emptyText: _t('Selected region'),
            listeners: {
                select: function (combo, record, index) {
                    var selectedRegionId = record[0].data.Id;
                    window.feature.store.loadPage(1, { params: { regionId: selectedRegionId} });
                }
            }
        });
        function GetSelectedCountryId() {
            return Ext.getCmp(window.feature.comboboxCountriesId).getValue();
        }
        function GetSelectedRegionId() {
            Ext.getCmp(window.feature.comboboxRegionsId).getValue()
        }
        window.feature.store = Ext.create('Ext.data.Store', {
            pageSize: 15,
            remoteSort: true,
            fields: ['Name', 'OutpostNo', 'Id', 'ClientId', 'RegionId'],
            proxy: {
                type: 'ajax',
                url: '@Url.RouteUrl(OutpostManagementAreaRegistration.DEFAULT_ROUTE, new { controller = "District", action = "Index" })',
                params: { countryId: GetSelectedCountryId(), regionId: GetSelectedRegionId() },
                reader: { type: 'json',
                    root: 'districts',
                    totalProperty: 'TotalItems'
                },
                simpleSortMode: true

            },
            sorters: [{
                property: 'Name',
                direction: 'DESC'
            }]
        });

        window.feature.grid = Ext.create('Ext.grid.Panel', {
            title: 'Districts',
            store: window.feature.store,
            disableSelection: true,
            loadMask: true,
            columns: [{
                text: "Name",
                dataIndex: 'Name',
                anchor: '90%',
                sortable: true
            }, {
                text: "No of outposts",
                dataIndex: 'OutpostNo',
                sortable: true
            }, {
                xtype: 'actioncolumn',
                items: [{
                    icon: '../../Assets/img/delete.png',
                    tooltip: _t('Remove this district'),
                    handler: function (grid, rowIndex, colIndex) {
                        var record = grid.store.getAt(rowIndex);

                        Ext.MessageBox.confirm('Confirm', 'Are you sure you want to delete the district?', function (button) {

                            var values = { guid: record.data.Id
                            };
                            if (button === 'yes') {

                                var postToUrl = '@Url.RouteUrl(OutpostManagementAreaRegistration.DEFAULT_ROUTE, new { controller = "District", action = "Delete" })';
                                var action = $.post(postToUrl, values);
                                action.success(function (result) {
                                    if (result.error !== 'done') {
                                        var windowAlert = new Ext.window.MessageBox;
                                       windowAlert.alert('Alert', result.error);
                                       // windowAlert.show();
                                    }
                                    var selectedCountryId = Ext.getCmp(window.feature.comboboxCountriesId).getValue();
                                    var selectedRegionId = Ext.getCmp(window.feature.comboboxRegionsId).getValue();

                                    if (selectedRegionId) {
                                        GetStoreWithDistrictsSpecificToRegionWith(selectedRegionId);
                                    } else {
                                        if (selectedCountryId)
                                        { GetStoreWithDistrictsSpecificToCountryWith(selectedCountryId); }
                                        else {
                                            window.feature.store.loadPage(1);
                                        }
                                    }

                                });

                            }

                        });


                    }

                }, {
                    icon: '../../Assets/img/edit.png',
                    tooltip: _t('Edit this district'),
                    handler: function (grid, rowIndex, colIndex) {
                        var record = grid.store.getAt(rowIndex);
                        var selectedCountryId = Ext.getCmp(window.feature.comboboxCountriesId).getValue();
                        var selectedRegionId = Ext.getCmp(window.feature.comboboxRegionsId).getValue();


                        var modalForEdit = new window.feature.modalEdit();
                        Ext.getCmp(window.feature.districtNameId).setValue(record.data.Name);
                        Ext.getCmp(window.feature.clientId).setValue(record.data.ClientId);
                        Ext.getCmp(window.feature.DistrictId).setValue(record.data.Id);
                        modalForEdit.show();

                    }
                }

            ]
            }],
            bbar: Ext.create('Ext.PagingToolbar', {
                store: window.feature.store,
                displayInfo: true,
                displayMsg: 'Displaying topics {0} - {1} of {2}',
                emptyMsg: "No topics to display"
            })
        });
        function GetStoreWithDistrictsByNameSpecificToRegionWith(SelectedRegionId, SearchByName) {
            window.feature.store.loadPage(1, { params: { RegionId: SelectedRegionId, SearchName: SearchByName} });
        }
        function GetStoreWithDistrictsSpecificToRegionWith(SelectedRegionId) {
            window.feature.store.loadPage(1, { params: { RegionId: SelectedRegionId} });
        }
        function GetStoreWithDistrictsByNameSpecificToCountryWith(SelectedCountryId, SearchByName) {
            window.feature.store.loadPage(1, { params: { CountryId: SelectedCountryId, SearchName: SearchByName} });
        }
        function GetStoreWithDistrictsSpecificToCountryWith(SelectedCountryId) {
            window.feature.store.loadPage(1, { params: { CountryId: SelectedCountryId} });
        }
        function GetStoreWithDistrictsByName(SearchByName) {
            window.feature.store.loadPage(1, { params: { SearchName: SearchByName} });
        }
        var contentRes = window.res.content;
        var mainContent = Ext.getCmp(contentRes.maincontent.id);
        mainContent.add({
            xtype: 'container',
            margin: 20,
            id: 'TopContainer',
            border: '10 10 10 10',
            layout: {
                align: 'stretch',
                type: 'vbox'
            },
            items: [
                      {
                          xtype: 'container',
                          layout: {
                              type: 'column'
                          },
                          height: 50,
                          items: [{ xtype: 'container',
                              height: 30,
                              width: 30,
                              html: '&nbsp;'
                          }, {
                              xtype: 'label',
                              text: 'District Administration'
                          }, {
                              xtype: 'button',
                              margin: '0 0 0 20',
                              text: 'Add New District',
                              width: 150,
                              handler: function () {
                                  var districtModal = new window.feature.modal();

                                  districtModal.show();
                              }
                          }, {
                              xtype: 'textfield',
                              emptyText: 'Search District',
                              margin: '0 0 0 850',
                              id: window.feature.searchTextFieldId,
                              enableKeyEvents: true,
                              listeners: {
                                  specialkey: function (field, e) {
                                      if (e.getKey() == Ext.EventObject.ESC) {
                                          var selectedCountryId = Ext.getCmp(window.feature.comboboxCountriesId).getValue();
                                          var selectedRegionId = Ext.getCmp(window.feature.comboboxRegionsId).getValue();
                                          var searchByName = Ext.getCmp(window.feature.searchTextFieldId).getValue();

                                          Ext.getCmp(window.feature.searchTextFieldId).setValue('');
                                          if (selectedRegionId) {
                                              GetStoreWithDistrictsSpecificToRegionWith(selectedRegionId)
                                          } else {
                                              if (selectedCountryId) {
                                                  GetStoreWithDistrictsSpecificToCountryWith(selectedCountryId)
                                              } else {
                                                  window.feature.store.loadPage(1);
                                              }
                                          }
                                      }
                                  },
                                  keyup: function () {

                                      var selectedCountryId = Ext.getCmp(window.feature.comboboxCountriesId).getValue();
                                      var selectedRegionId = Ext.getCmp(window.feature.comboboxRegionsId).getValue();
                                      var searchByName = Ext.getCmp(window.feature.searchTextFieldId).getValue();

                                      clearTimeout(timeout);
                                      timeout = setTimeout(function () {

                                          if (selectedRegionId) {
                                              GetStoreWithDistrictsByNameSpecificToRegionWith(selectedRegionId, searchByName);
                                          } else {
                                              if (selectedCountryId) {
                                                  GetStoreWithDistrictsByNameSpecificToCountryWith(selectedCountryId, searchByName);
                                              }
                                              else {
                                                  GetStoreWithDistrictsByName(searchByName);
                                              }
                                          }
                                      }, 1000);


                                  }
                              }
                          }]
                      }, {
                          xtype: 'container',
                          layout: {
                              type: 'hbox'
                          },
                          height: 50,
                          items: [
                                window.feature.comboBoxCountries,
                                window.feature.comboBoxRegions
                            ]
                      },
                       window.feature.grid
                    ]
        });

        window.feature.countriesStore.load();

    });
</script>
