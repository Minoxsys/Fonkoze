@model Web.Areas.OutpostManagement.Models.District.DistrictOverviewModel
@using Microsoft.Web.Mvc
@{
    ViewBag.Title = "Overview";
}
@section page_title{
Districts: Overview
}
@section breadcrumbs{
    @Url.HomeLink("Outpost Administration") > Districts
}
@section master_content{
    @if (Model.Error != null)
    {
        <div class="error">
            @Model.Error
        </div>
    }
    <div class="page_header_buttons">
     @Html.ActionLink("Add new district", "Create", "District", null, new { id = "create" })
        
    </div>
    <br />
   
    <table>
        <thead>
            <tr>
                <th>
                    <label>
                        Country:</label>
                    <select name="@(Html.NameFor(m => m.Countries))">
                        <option value="@Guid.Empty">- Select a country - </option>
                        @{
                            foreach (var item in Model.Countries)
                            {
                            <option value="@item.Value" @(item.Selected ? @"selected='selected'" : @"") >@item.Text</option>
                            }
                        }
                    </select>
                </th>
                <th>
                    <label>
                        Region:</label>
                    <select name="@(Html.NameFor(m => m.Regions))" id="Regions">
                    @if(Model.Regions.Count > 0){
                        <option value="@Guid.Empty">- Select a region - </option>
                       
                            foreach (var item in Model.Regions)
                            {
                            <option value="@item.Value" @(item.Selected ? @"selected='selected'" : @"") >@item.Text</option>
                            }
                        
                    }
                    </select>
                </th>
                <th><br />
                     <input type="text" id="districtSearch"  class="input" name="districtSearch" maxlength="50" placeholder="Districts search" style="width:200px; height:30px; margin-left:0px" />
                </th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    @{
        Html.RenderPartial("OverviewTable", Model.Districts);
    }
}
@section master_actions{
    @{
        Html.RenderPartial("~/Views/Shared/_OutpostManagementActions.cshtml");
    }
}
@section scripts{
    <script type="text/javascript">
        var timeout;

        $(function () {
            $(".delete-user-form").submit(function () {
                return confirm('Are you sure that you want to delete this district?')
            });

            $("select[name='@Html.NameFor(m => m.Countries)']").change(onCountryChanged);

            $("input").keyup(function () {

                clearTimeout(timeout);
                var selectedId = $("select[name='@Html.NameFor(m => m.Regions)']").val();
                var selectedCountryId = $("select[name='@Html.NameFor(m => m.Countries)']").val();

                if (selectedId == "@Guid.Empty") {

                    timeout = setTimeout("searchDistrictByName('"+selectedCountryId+"')", 1000);
                }
                else {
                    SearchDistrictOnFilterSelected();
                }
            });

            //            var selectedRegionId = $("select[name='@Html.NameFor(m => m.Regions)']").val();
            //            var selectedCountryId = $("select[name='@Html.NameFor(m => m.Countries)']").val();

            //            document.getElementById('create').href = '@Url.Action("Create")?countryId=' + selectedCountryId + '&regionId=' + selectedRegionId;
        });

        function searchDistrictByName(selectedCountryId) {

            var districtName = document.getElementById("districtSearch").value;
            var drop = $("#district-overview")

            var urlOverview = '@Url.Action("SearchForDistrictWithName")?districtName=' + districtName + '&countryId=' + selectedCountryId;
            clearTimeout(timeout);
            $.get(urlOverview, function (data) {

                drop.html('')

                $('#district-overview').html(data);
                clearTimeout(timeout);
            });
            //GetAllButtonsForPaginationAndSetOnClickEvent();
        }

        $("select[name='@Html.NameFor(m => m.Regions)']").change(function () {

            var selectedRegionId = $("select[name='@Html.NameFor(m => m.Regions)']").val();
            var selectedCountryId = $("select[name='@Html.NameFor(m => m.Countries)']").val();

            document.getElementById('create').href = '@Url.Action("Create")?countryId=' + selectedCountryId + '&regionId=' + selectedRegionId;
            debugger;
            $("#Regions option[value='@Guid.Empty.ToString()']").remove();
            var drop = $("#district-overview")
            drop.html('')

            var urlOverview = '@Url.Action("OverviewTable")?regionId=' + selectedRegionId;
            $.get(urlOverview, function (data) {
                console.log(data);
                $('#district-overview').html(data);
            });

        });

        function onCountryChanged() {
            var e = $(this)[0];
            var selectedCountryId = e.options[e.selectedIndex].value;


            $.getJSON('@Url.Action("GetRegionsForCountry", "District")?countryId=' + selectedCountryId, function (data) {

                var drop = $("#district-overview")
                drop.html('')

                var drop = $("#Regions")
                drop.html('')

                //var ddlRegions = document.getElementById("Regions");
                var ddlRegions = document.getElementById("Regions");
                var opt = document.createElement("option");
                opt.text = 'Please select a region';
                opt.value = '@Guid.Empty.ToString()';
                ddlRegions.options.add(opt);
                $.each(data, function () {
                    var opt = document.createElement("option");
                    opt.text = this['Text'];
                    opt.value = this['Value'];
                    ddlRegions.options.add(opt);
                });

            });

            var selectedRegionId = $("select[name='@Html.NameFor(m => m.Regions)']").val();
            
            document.getElementById('create').href = '@Url.Action("Create")?countryId=' + selectedCountryId + '&regionId=' + selectedRegionId;
            $("select[name='@Html.NameFor(m => m.Countries)'] option[value='@Guid.Empty.ToString()']").remove();
        }

        //search for districts by Name

        jQuery.expr[":"].containsNoCase = function (el, i, m) {
            var search = m[3];
            if (!search) return false;
            return eval("/" + search + "/i").test($(el).text());
        };

       // jQuery(document).ready(function () {
          function SearchDistrictOnFilterSelected() {  
            // cancel the search if the user presses the ESC key
            jQuery('#districtSearch').keyup(function (event) {
                if (event.keyCode == 27) {
                    resetSearch();
                }
            });

            // execute the search
            jQuery('#districtSearch').keyup(function () {
                // only search when there are 3 or more characters in the textbox
                if (jQuery('#districtSearch').val().length > 0) {
                    // hide all rows
                    jQuery('#districts-table tr').hide();
                    // show the header row
                    jQuery('#districts-table tr:first').show();
                    // show the matching rows (using the containsNoCase from Rick Strahl)
                    jQuery('#districts-table tr .search:containsNoCase(\'' + jQuery('#districtSearch').val() + '\')').parent().show();
               }
                else if (jQuery('#districtSearch').val().length == 0) {
                    // if the user removed all of the text, reset the search
                    resetSearch();
                }

                // if there were no matching rows, tell the user
                if (jQuery('#districts-table tr:visible').length == 1) {
                    // remove the norecords row if it already exists
                    jQuery('.norecords').remove();
                    // add the norecords row
                    jQuery('#districts-table').append('<tr class="norecords"><td colspan="5" class="Normal">No records were found</td></tr>');
                }
            });
        }//);

        function resetSearch() {
            // clear the textbox
            jQuery('#districtSearch').val('');
            // show all table rows
            jQuery('#districts-table tr').show();
            // remove any no records rows
            jQuery('.norecords').remove();           
            // make sure we re-focus on the textbox for usability
            jQuery('#districtSearch').focus();
        }

    </script>
}
